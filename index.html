<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Imputaciones Semanales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 50%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #2563eb 0%, #4f46e5 50%, #7c3aed 100%);
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: bold;
        }

        .header-subtitle {
            color: #bfdbfe;
            margin-top: 0.5rem;
        }

        .btn-festivos {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .btn-festivos:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .content {
            padding: 2rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border-radius: 1rem;
            border: 2px solid;
        }

        .input-group.blue {
            background: linear-gradient(90deg, #eff6ff 0%, #e0e7ff 100%);
            border-color: #93c5fd;
        }

        .input-group.purple {
            background: linear-gradient(90deg, #faf5ff 0%, #fce7f3 100%);
            border-color: #d8b4fe;
        }

        .input-group.green {
            background: linear-gradient(90deg, #f0fdf4 0%, #d1fae5 100%);
            border-color: #86efac;
        }

        .input-group.orange {
            background: linear-gradient(90deg, #fff7ed 0%, #fecaca 100%);
            border-color: #fdba74;
        }

        .input-group label {
            display: block;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }

        .input-group input[type="week"],
        .input-group input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(90deg, #2563eb 0%, #4f46e5 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, #1d4ed8 0%, #4338ca 100%);
        }

        .btn-success {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #059669 0%, #047857 100%);
        }

        .btn-warning {
            background: linear-gradient(90deg, #f59e0b 0%, #ef4444 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(90deg, #d97706 0%, #dc2626 100%);
        }

        .btn-secondary {
            background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-green {
            background: linear-gradient(90deg, #16a34a 0%, #059669 100%);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-group.vertical {
            flex-direction: column;
        }

        .day-button {
            width: 100%;
            padding: 1.25rem;
            border: 2px solid #d1d5db;
            background: white;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .day-button:hover {
            border-color: #93c5fd;
            background: #f9fafb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .day-button.selected {
            background: linear-gradient(90deg, #dbeafe 0%, #e0e7ff 100%);
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .day-button .day-name {
            font-weight: bold;
            font-size: 1.125rem;
        }

        .activity-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            background: white;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }

        .activity-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .activity-header h3 {
            font-size: 1.125rem;
            font-weight: bold;
            color: #1f2937;
        }

        .activity-days {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .activity-day-btn {
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .activity-day-btn:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .activity-day-btn.selected {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .activity-day-btn:not(.selected) {
            background: #f3f4f6;
            color: #374151;
        }

        .table-container {
            overflow-x: auto;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(90deg, #2563eb 0%, #4f46e5 100%);
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: bold;
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        tbody tr:hover {
            background: #eff6ff;
        }

        td {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            color: #374151;
        }

        td:first-child {
            font-weight: 600;
            color: #1f2937;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-list li {
            margin-bottom: 0.25rem;
            color: #374151;
        }

        .hidden {
            display: none;
        }

        .add-activity {
            background: linear-gradient(90deg, #f0fdf4 0%, #d1fae5 100%);
            border: 2px solid #86efac;
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .add-activity h3 {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.125rem;
            color: #1f2937;
        }

        .add-activity-input {
            display: flex;
            gap: 0.5rem;
        }

        .add-activity-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #86efac;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .add-activity-input input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .holiday-calendar {
            background: linear-gradient(90deg, #fff7ed 0%, #fecaca 100%);
            border: 2px solid #fdba74;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .holiday-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .holiday-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .holiday-info {
            color: #4b5563;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .month-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .month-title {
            font-weight: bold;
            font-size: 1.125rem;
            text-align: center;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }

        .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .weekday-header div {
            text-align: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #6b7280;
            padding: 0.25rem;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .calendar-day {
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .calendar-day:not(:disabled):hover {
            background: #dbeafe;
        }

        .calendar-day.other-month {
            color: #d1d5db;
            cursor: default;
        }

        .calendar-day.weekend {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: default;
        }

        .calendar-day.weekday {
            background: #f3f4f6;
            color: #374151;
        }

        .calendar-day.holiday {
            background: #ef4444;
            color: white;
            font-weight: bold;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2);
        }

        .calendar-day.holiday:hover {
            background: #dc2626;
        }

        @media (max-width: 640px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .calendar-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="header-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <h1>Gestor de Imputaciones Semanales</h1>
                </div>
                <p class="header-subtitle">Automatiza tus reportes semanales de forma sencilla</p>
            </div>
            <button class="btn-festivos" onclick="toggleHolidayCalendar()">üóìÔ∏è Festivos</button>
        </div>

        <div class="content">
            <!-- Calendario de Festivos -->
            <div id="holidayCalendar" class="holiday-calendar hidden">
                <div class="holiday-header">
                    <h2>üìÖ Gesti√≥n de Festivos 2026</h2>
                    <button class="btn btn-warning" onclick="toggleHolidayCalendar()">Cerrar</button>
                </div>
                <p class="holiday-info">
                    Selecciona los d√≠as festivos de tu empresa. Los d√≠as marcados no aparecer√°n en las imputaciones semanales.
                    Total festivos marcados: <strong id="holidayCount">0</strong>
                </p>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="clearAllHolidays()">Limpiar todos</button>
                </div>
            </div>

            <!-- Paso 1: Selecci√≥n de semana -->
            <div id="step1">
                <div class="input-group blue">
                    <label>üìÖ Selecciona la semana:</label>
                    <input type="week" id="weekInput" onchange="handleWeekSelect()">
                </div>

                <div class="input-group purple">
                    <label>üè¢ PD (Proyecto/Departamento):</label>
                    <input type="text" id="pdInput" placeholder="Introduce el c√≥digo del proyecto">
                </div>

                <div id="attendanceQuestion" class="input-group green hidden">
                    <label>üíº ¬øHas asistido todos los d√≠as al trabajo esta semana?</label>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="handleAllDaysWorked(true)" style="flex: 1;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            S√≠, todos los d√≠as
                        </button>
                        <button class="btn btn-warning" onclick="handleAllDaysWorked(false)" style="flex: 1;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            No, faltaron d√≠as
                        </button>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Selecci√≥n de d√≠as -->
            <div id="step2" class="hidden">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937;">üìã Selecciona los d√≠as que s√≠ asististe:</h2>
                <div id="daysContainer"></div>
                <button class="btn btn-primary" onclick="continueToActivities()" style="width: 100%; margin-top: 1rem; font-size: 1.125rem;">
                    Continuar ‚Üí
                </button>
            </div>

            <!-- Paso 3: Selecci√≥n de actividades -->
            <div id="step3" class="hidden">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937;">üéØ Selecciona las actividades realizadas:</h2>

                <div class="add-activity">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        A√±adir actividad personalizada
                    </h3>
                    <div class="add-activity-input">
                        <input type="text" id="newActivityInput" placeholder="Nombre de la nueva actividad" onkeypress="if(event.key==='Enter') addCustomActivity()">
                        <button class="btn btn-green" onclick="addCustomActivity()">A√±adir</button>
                    </div>
                </div>

                <div id="activitiesContainer"></div>

                <button class="btn btn-primary" onclick="generateTable()" style="width: 100%; margin-top: 1rem; font-size: 1.125rem;">
                    üìä Generar Tabla
                </button>
            </div>

            <!-- Paso 4: Vista de tabla -->
            <div id="step4" class="hidden">
                <h2 style="font-size: 1.875rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937;">üìã Tabla de Imputaciones</h2>

                <div class="table-container">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th>D√≠a de la semana</th>
                                <th>Fecha</th>
                                <th>PD</th>
                                <th>Tareas</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div class="btn-group">
                    <button class="btn btn-green" onclick="copyTableToClipboard()" style="flex: 1; font-size: 1.125rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                        Copiar para Email
                    </button>
                    <button class="btn btn-secondary" onclick="resetApp()" style="flex: 1; font-size: 1.125rem;">
                        üîÑ Nueva Imputaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global de la aplicaci√≥n
        const appState = {
            selectedWeek: '',
            weekDates: [],
            workDays: [],
            pd: '',
            holidays: [],
            activities: {
                'Reunion Diaria': [],
                'Ausf√ºhrungsplan': [],
                'Entwurfsplan': [],
                'Konstruktionsplan y St√ºckliste': [],
                'Gesamtst√ºckliste': [],
                'Radio Elektro': [],
                'Speedboat': [],
                'RaceCard': [],
                '2ndPL': [],
                'Revision de TI Dokumentation': [],
                'TI Dokumentacion': [],
                'Nokia Dokumentation': [],
                'CW Dokumentation': [],
                'AS Built': []
            },
            customActivities: []
        };

        const dayNames = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];

        // Inicializar calendario de festivos
        function initHolidayCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const months = generateCalendarMonths();
            
            calendarGrid.innerHTML = '';
            months.forEach((month, idx) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                
                let html = `
                    <div class="month-title">${month.name} 2026</div>
                    <div class="weekday-header">
                        <div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>S√°</div><div>Do</div>
                    </div>
                    <div class="days-grid">
                `;
                
                month.days.forEach(day => {
                    let className = 'calendar-day';
                    let disabled = '';
                    let onclick = '';
                    
                    if (!day.isCurrentMonth) {
                        className += ' other-month';
                        disabled = 'disabled';
                    } else if (!day.isWeekday) {
                        className += ' weekend';
                        disabled = 'disabled';
                    } else {
                        className += ' weekday';
                        if (isHoliday(day.dateString)) {
                            className += ' holiday';
                        }
                        onclick = `onclick="toggleHoliday('${day.dateString}')"`;
                    }
                    
                    html += `<button class="${className}" ${disabled} ${onclick} title="${day.dateString || ''}">${day.date}</button>`;
                });
                
                html += '</div>';
                monthCard.innerHTML = html;
                calendarGrid.appendChild(monthCard);
            });
            
            updateHolidayCount();
        }

        function generateCalendarMonths() {
            const months = [];
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(2026, month, 1);
                const lastDay = new Date(2026, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const firstDayOfWeek = firstDay.getDay();
                
                const prevMonthLastDay = new Date(2026, month, 0).getDate();
                const prevMonthDays = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
                
                const calendarDays = [];
                
                for (let i = prevMonthDays - 1; i >= 0; i--) {
                    const dayNum = prevMonthLastDay - i;
                    calendarDays.push({
                        date: dayNum,
                        isCurrentMonth: false,
                        dateString: null,
                        dayOfWeek: null
                    });
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(2026, month, day);
                    const dayOfWeek = date.getDay();
                    const dateString = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    
                    calendarDays.push({
                        date: day,
                        isCurrentMonth: true,
                        dateString: dateString,
                        dayOfWeek: dayOfWeek,
                        isWeekday: dayOfWeek >= 1 && dayOfWeek <= 5
                    });
                }
                
                const remainingDays = 7 - (calendarDays.length % 7);
                if (remainingDays < 7) {
                    for (let i = 1; i <= remainingDays; i++) {
                        calendarDays.push({
                            date: i,
                            isCurrentMonth: false,
                            dateString: null,
                            dayOfWeek: null
                        });
                    }
                }
                
                months.push({
                    name: monthNames[month],
                    days: calendarDays
                });
            }
            return months;
        }

        function toggleHolidayCalendar() {
            const calendar = document.getElementById('holidayCalendar');
            if (calendar.classList.contains('hidden')) {
                calendar.classList.remove('hidden');
                initHolidayCalendar();
            } else {
                calendar.classList.add('hidden');
            }
        }

        function isHoliday(dateString) {
            return appState.holidays.includes(dateString);
        }

        function toggleHoliday(dateString) {
            const index = appState.holidays.indexOf(dateString);
            if (index > -1) {
                appState.holidays.splice(index, 1);
            } else {
                appState.holidays.push(dateString);
            }
            initHolidayCalendar();
        }

        function clearAllHolidays() {
            if (confirm('¬øEst√°s seguro de que quieres borrar todos los festivos?')) {
                appState.holidays = [];
                initHolidayCalendar();
            }
        }

        function updateHolidayCount() {
            document.getElementById('holidayCount').textContent = appState.holidays.length;
        }

        function getWeekDates(weekString) {
            const [year, week] = weekString.split('-W');
            const date = new Date(year, 0, 1 + (week - 1) * 7);
            const dayOfWeek = date.getDay();
            const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(date.setDate(diff));
            
            const dates = [];
            for (let i = 0; i < 5; i++) {
                const currentDate = new Date(monday);
                currentDate.setDate(monday.getDate() + i);
                const dateString = currentDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                if (!isHoliday(dateString)) {
                    dates.push({
                        day: dayNames[i],
                        date: dateString
                    });
                }
            }
            return dates;
        }

        function handleWeekSelect() {
            const weekInput = document.getElementById('weekInput');
            const pdInput = document.getElementById('pdInput');
            
            appState.selectedWeek = weekInput.value;
            appState.pd = pdInput.value;
            
            if (appState.selectedWeek && appState.pd) {
                appState.weekDates = getWeekDates(appState.selectedWeek);
                document.getElementById('attendanceQuestion').classList.remove('hidden');
            }
        }

        // Actualizar PD cuando cambie
        document.getElementById('pdInput').addEventListener('input', handleWeekSelect);

        function handleAllDaysWorked(allDays) {
            if (allDays) {
                appState.workDays = [...appState.weekDates];
                showStep(3);
                renderActivities();
            } else {
                showStep(2);
                renderDaySelection();
            }
        }

        function renderDaySelection() {
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';
            
            appState.weekDates.forEach(day => {
                const button = document.createElement('button');
                button.className = 'day-button';
                button.onclick = () => toggleWorkDay(day);
                
                const isSelected = appState.workDays.some(d => d.day === day.day);
                if (isSelected) {
                    button.classList.add('selected');
                }
                
                button.innerHTML = `
                    <span class="day-name">${day.day}</span>
                    <span>${day.date}</span>
                `;
                
                container.appendChild(button);
            });
        }

        function toggleWorkDay(day) {
            const index = appState.workDays.findIndex(d => d.day === day.day);
            if (index > -1) {
                appState.workDays.splice(index, 1);
            } else {
                appState.workDays.push(day);
            }
            renderDaySelection();
        }

        function continueToActivities() {
            if (appState.workDays.length === 0) {
                alert('Por favor, selecciona al menos un d√≠a');
                return;
            }
            showStep(3);
            renderActivities();
        }

        function renderActivities() {
            const container = document.getElementById('activitiesContainer');
            container.innerHTML = '';
            
            const allActivities = Object.keys(appState.activities);
            
            allActivities.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'activity-card';
                
                const header = document.createElement('div');
                header.className = 'activity-header';
                
                const title = document.createElement('h3');
                title.textContent = activity;
                header.appendChild(title);
                
                if (appState.customActivities.includes(activity)) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
                    deleteBtn.onclick = () => removeCustomActivity(activity);
                    header.appendChild(deleteBtn);
                }
                
                card.appendChild(header);
                
                const daysGrid = document.createElement('div');
                daysGrid.className = 'activity-days';
                
                appState.workDays.forEach(day => {
                    const dayBtn = document.createElement('button');
                    dayBtn.className = 'activity-day-btn';
                    dayBtn.textContent = day.day.substring(0, 3);
                    
                    const isSelected = appState.activities[activity].some(d => d.day === day.day);
                    if (isSelected) {
                        dayBtn.classList.add('selected');
                    }
                    
                    dayBtn.onclick = () => toggleActivityDay(activity, day);
                    daysGrid.appendChild(dayBtn);
                });
                
                card.appendChild(daysGrid);
                container.appendChild(card);
            });
        }

        function toggleActivityDay(activity, day) {
            const index = appState.activities[activity].findIndex(d => d.day === day.day);
            if (index > -1) {
                appState.activities[activity].splice(index, 1);
            } else {
                appState.activities[activity].push(day);
            }
            renderActivities();
        }

        function addCustomActivity() {
            const input = document.getElementById('newActivityInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            if (appState.activities[name]) {
                alert('Esta actividad ya existe');
                return;
            }
            
            appState.customActivities.push(name);
            appState.activities[name] = [];
            input.value = '';
            renderActivities();
        }

        function removeCustomActivity(activity) {
            if (confirm(`¬øEliminar la actividad "${activity}"?`)) {
                const index = appState.customActivities.indexOf(activity);
                if (index > -1) {
                    appState.customActivities.splice(index, 1);
                }
                delete appState.activities[activity];
                renderActivities();
            }
        }

        function generateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const grouped = {};
            
            Object.entries(appState.activities).forEach(([activity, days]) => {
                days.forEach(day => {
                    if (!grouped[day.day]) {
                        grouped[day.day] = {
                            day: day.day,
                            date: day.date,
                            tasks: []
                        };
                    }
                    grouped[day.day].tasks.push(activity);
                });
            });
            
            const rows = dayNames
                .map(dayName => grouped[dayName])
                .filter(item => item !== undefined);
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.day}</td>
                    <td>${row.date}</td>
                    <td>${appState.pd}</td>
                    <td>
                        <ul class="task-list">
                            ${row.tasks.map(task => `<li>‚Ä¢ ${task}</li>`).join('')}
                        </ul>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            showStep(4);
        }

        async function copyTableToClipboard() {
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            let html = `<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; font-family: Arial, sans-serif; font-size: 13px; width: 100%; max-width: 800px;">
                <thead>
                    <tr style="background-color: #2563eb; color: white;">
                        <th style="padding: 12px; text-align: left; width: 15%;">D√≠a de la semana</th>
                        <th style="padding: 12px; text-align: left; width: 15%;">Fecha</th>
                        <th style="padding: 12px; text-align: left; width: 15%;">PD</th>
                        <th style="padding: 12px; text-align: left; width: 55%;">Tareas</th>
                    </tr>
                </thead>
                <tbody>`;
            
            rows.forEach((row, idx) => {
                const cells = row.querySelectorAll('td');
                const bgColor = idx % 2 === 0 ? '#f3f4f6' : '#ffffff';
                const tasks = Array.from(cells[3].querySelectorAll('li')).map(li => li.textContent).join('<br>');
                
                html += `<tr style="background-color: ${bgColor};">
                    <td style="padding: 10px; border: 1px solid #d1d5db;"><strong>${cells[0].textContent}</strong></td>
                    <td style="padding: 10px; border: 1px solid #d1d5db;">${cells[1].textContent}</td>
                    <td style="padding: 10px; border: 1px solid #d1d5db;">${cells[2].textContent}</td>
                    <td style="padding: 10px; border: 1px solid #d1d5db;">${tasks}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            let textVersion = 'D√≠a de la semana\tFecha\tPD\tTareas\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const tasks = Array.from(cells[3].querySelectorAll('li')).map(li => li.textContent).join(', ');
                textVersion += `${cells[0].textContent}\t${cells[1].textContent}\t${cells[2].textContent}\t${tasks}\n`;
            });
            
            try {
                const htmlBlob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([textVersion], { type: 'text/plain' });
                
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': htmlBlob,
                        'text/plain': textBlob
                    })
                ]);
                
                alert('¬°Tabla copiada! Ahora puedes pegarla directamente en tu correo (Ctrl+V o Cmd+V).');
            } catch (err) {
                try {
                    await navigator.clipboard.writeText(html);
                    alert('Tabla copiada como HTML. P√©gala en tu correo.');
                } catch (err2) {
                    alert('Error al copiar. Por favor, intenta de nuevo o usa el navegador Chrome/Edge.');
                }
            }
        }

        function resetApp() {
            appState.selectedWeek = '';
            appState.weekDates = [];
            appState.workDays = [];
            appState.pd = '';
            appState.activities = {
                'Reunion Diaria': [],
                'Ausf√ºhrungsplan': [],
                'Entwurfsplan': [],
                'Konstruktionsplan y St√ºckliste': [],
                'Gesamtst√ºckliste': [],
                'Radio Elektro': [],
                'Speedboat': [],
                'RaceCard': [],
                '2ndPL': [],
                'Revision de TI Dokumentation': [],
                'TI Dokumentacion': [],
                'Nokia Dokumentation': [],
                'CW Dokumentation': [],
                'AS Built': []
            };
            appState.customActivities = [];
            
            document.getElementById('weekInput').value = '';
            document.getElementById('pdInput').value = '';
            document.getElementById('attendanceQuestion').classList.add('hidden');
            
            showStep(1);
        }

        function showStep(step) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            document.getElementById(`step${step}`).classList.remove('hidden');
        }

        // Inicializar la aplicaci√≥n
        showStep(1);
    </script>
</body>
</html>